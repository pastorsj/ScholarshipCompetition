---
title: "Data Exploration"
author: "Sam Pastoriza"
date: "5/4/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) {
  install.packages("pacman")
}

pacman::p_load(tidyverse, lubridate, tm, qdapDictionaries, stringr)
options(scipen = 999)
```

## Data Exploration

```{r}
contract.df = read.csv('./Dataset_Contract_Sub-Awards.csv') %>%
  mutate(prime_award_awarding_agency_name = as.factor(prime_award_awarding_agency_name),
         prime_award_awarding_sub_agency_name = as.factor(prime_award_awarding_sub_agency_name),
         prime_award_funding_office_name = as.factor(prime_award_funding_office_name),
         prime_award_funding_agency_name = as.factor(prime_award_funding_agency_name),
         prime_award_funding_sub_agency_name = as.factor(prime_award_funding_sub_agency_name),
         prime_awardee_parent_name = as.factor(prime_awardee_parent_name),
         prime_awardee_name = as.factor(prime_awardee_name),
         subawardee_parent_name = as.factor(subawardee_parent_name),
         subawardee_name = as.factor(subawardee_name),
         subaward_action_date = mdy(subaward_action_date))
contract.df$subcontract_id = 1:nrow(contract.df)
contract.df
```

## Basic Statistics

```{r}
# Number of sub contracts
nrow(contract.df)
# Number of unique contractors
contract.df %>%
  count(prime_awardee_name)
# Number of unique sub contractors
contract.df %>%
  count(prime_awardee_name)
# Most expensive contract
contract.df %>%
  arrange(desc(subaward_amount)) %>%
  select(prime_awardee_name, subawardee_name, subaward_amount, subaward_description)
# Most expensive company plus number of contracts
contract.df %>%
  group_by(subawardee_name) %>%
  summarize(NumberOfContracts = n(),
            TotalCostOfAllContracts = sum(subaward_amount)) %>%
  arrange(desc(TotalCostOfAllContracts))
  
```

## Sunburst Chart

```{r}
network.awards.df <- contract.df %>%
  select(prime_award_awarding_agency_name,
         prime_award_awarding_sub_agency_name,
         prime_award_funding_office_name,
         prime_award_funding_agency_name,
         prime_award_funding_sub_agency_name,
         prime_awardee_parent_name,
         prime_awardee_name,
         subawardee_parent_name,
         subawardee_name,
         subaward_amount)
network.awards.df
```

```{r}
sunburst.df <- data.frame(parent = c(""), id = c("All"), name = 'DOD', value = c(0), final_layer = FALSE)

first.layer <- network.awards.df %>%
  group_by(prime_award_awarding_sub_agency_name) %>%
  summarize(value = sum(subaward_amount)) %>%
  mutate(
    parent = "All",
    id = paste("All", prime_award_awarding_sub_agency_name, sep = "."),
    name = prime_award_awarding_sub_agency_name,
    final_layer = FALSE
  ) %>%
  ungroup() %>%
  select(-prime_award_awarding_sub_agency_name)

second.layer <- network.awards.df %>%
  group_by(prime_award_awarding_sub_agency_name, prime_awardee_name) %>%
  summarize(value = sum(subaward_amount)) %>%
  mutate(
    parent = paste("All", prime_award_awarding_sub_agency_name, sep = "."),
    id = paste("All", prime_award_awarding_sub_agency_name, prime_awardee_name, sep = "."),
    name = prime_awardee_name,
    final_layer = FALSE
  ) %>%
  ungroup() %>%
  select(-prime_award_awarding_sub_agency_name, -prime_awardee_name)

third.layer <- network.awards.df %>%
  group_by(prime_award_awarding_sub_agency_name, prime_awardee_name, subawardee_name) %>%
  summarize(value = sum(subaward_amount)) %>%
  mutate(
    parent = paste("All", prime_award_awarding_sub_agency_name, prime_awardee_name, sep = "."),
    id = paste("All", prime_award_awarding_sub_agency_name, prime_awardee_name, subawardee_name, sep = "."),
    name = subawardee_name,
    final_layer = TRUE
  ) %>%
  ungroup() %>%
  select(-prime_award_awarding_sub_agency_name, -prime_awardee_name, -subawardee_name)

sunburst.viz.df <- do.call("rbind", list(sunburst.df, first.layer, second.layer, third.layer))
sunburst.viz.df

write.csv(sunburst.viz.df %>% mutate(value = as.character(value)), "./visualization_data/award_relationships.csv", row.names = FALSE)
```

## Subcontracts over time

```{r}
cost.contracts.df <- contract.df %>%
  select(subawardee_name, subaward_action_date, subaward_amount, subaward_description) %>%
  arrange(subaward_action_date) %>%
  mutate(total_cost = cumsum(subaward_amount))

write.csv(cost.contracts.df %>% mutate(total_cost = as.character(total_cost)), "./visualization_data/contract_costs_time.csv", row.names = FALSE)
```

## Subcontract Network

```{r}
top.subcontracts.df <- contract.df %>%
  group_by(subawardee_name) %>%
  summarize(NumberOfContracts = n(),
            TotalCostOfAllContracts = sum(subaward_amount)) %>%
  arrange(desc(TotalCostOfAllContracts)) %>%
  slice(1:8)

second.layer <- contract.df %>%
  select(subcontract_id, subawardee_name) %>%
  filter(subawardee_name %in% top.subcontracts.df$subawardee_name) %>%
  mutate(from = as.character(subcontract_id),
         to = as.character(subawardee_name)) %>%
  select(from, to)

first.layer <- contract.df %>%
  select(subcontract_id, prime_awardee_name) %>%
  filter(subcontract_id %in% second.layer$from) %>%
  mutate(from = as.character(prime_awardee_name),
         to = as.character(subcontract_id)) %>%
  select(from, to)

write.csv(do.call('rbind', list(first.layer, second.layer)), "./visualization_data/subcontract_network.csv", row.names = FALSE)
```

## Subcontract Nodes

```{r}
all.costs.df <- contract.df %>%
  select(subcontract_id, subaward_description, subaward_amount) %>%
  rename(id = subcontract_id,
         description = subaward_description,
         cost = subaward_amount) %>%
  mutate(type = 'subcontract',
         name = description) %>%
  select(id, name, description, cost, type)
all.costs.df[nrow(all.costs.df) + 1,] <- c(as.character(contract.df$prime_awardee_name[1]), 
                                           as.character(contract.df$prime_awardee_name[1]), 
                                           as.character(contract.df$prime_award_description[1]), 
                                           contract.df$prime_award_amount[1], 
                                           'contractee')

all.subcontracters.df <- contract.df %>%
  select(subawardee_name, subaward_amount) %>%
  group_by(subawardee_name) %>%
  summarize(cost = sum(subaward_amount)) %>%
  ungroup() %>%
  mutate(id = subawardee_name,
         name = subawardee_name,
         description = subawardee_name,
         type = 'subawardee') %>%
  select(id, name, description, cost, type)
  
result.costs.df <- rbind(all.costs.df, all.subcontracters.df) %>%
  filter(id %in% first.layer$from | 
         id %in% first.layer$to | 
         id %in% second.layer$from | 
         id %in% second.layer$to)

# Scaled radius
a <- 10
b <- 50
result.costs.df <- result.costs.df %>%
  select(id, name, description, cost, type) %>%
  mutate(cost = as.numeric(cost)) %>%
  mutate(scaled_radius = round(((b - a) * (cost - min(.$cost))) / (max(.$cost) - min(.$cost)), digits = 0) + a)


result.costs.df <- result.costs.df %>%
  mutate(cost = as.character(cost))
write.csv(result.costs.df, "./visualization_data/all_costs.csv", row.names = FALSE)
```

## Further contract analysis

```{r}
# Attempt to do some NLP to remove some of the contracts
filtered.contract.descriptions <- c('Cost Plus Fixed Fee', 'Firm Fixed Price')
filtered.contracts.df <- contract.df %>%
  filter(!(subaward_description %in% filtered.contract.descriptions)) %>%
  mutate(subawardee_name = as.factor(as.character(subawardee_name)))
table(filtered.contracts.df$subaward_description)
```

```{r}
top.filtered.subcontracts.df <- filtered.contracts.df %>%
  group_by(subawardee_name) %>%
  summarize(NumberOfContracts = n(),
            TotalCostOfAllContracts = sum(subaward_amount)) %>%
  arrange(desc(TotalCostOfAllContracts)) %>%
  slice(1:10)

filtered.second.layer <- filtered.contracts.df %>%
  select(subcontract_id, subawardee_name) %>%
  filter(subawardee_name %in% top.filtered.subcontracts.df$subawardee_name) %>%
  mutate(from = as.character(subcontract_id),
         to = as.character(subawardee_name)) %>%
  select(from, to)

filtered.first.layer <- filtered.contracts.df %>%
  select(subcontract_id, prime_awardee_name) %>%
  filter(subcontract_id %in% filtered.second.layer$from) %>%
  mutate(from = as.character(prime_awardee_name),
         to = as.character(subcontract_id)) %>%
  select(from, to)

write.csv(do.call('rbind', list(filtered.first.layer, filtered.second.layer)), "./visualization_data/filtered_subcontract_network.csv", row.names = FALSE)
```

```{r}
all.filtered.costs.df <- filtered.contracts.df %>%
  select(subcontract_id, subaward_description, subaward_amount) %>%
  rename(id = subcontract_id,
         description = subaward_description,
         cost = subaward_amount) %>%
  mutate(type = 'subcontract',
         name = description) %>%
  select(id, name, description, cost, type)
all.filtered.costs.df[nrow(all.filtered.costs.df) + 1,] <- c(as.character(contract.df$prime_awardee_name[1]), 
                                                             as.character(contract.df$prime_awardee_name[1]), 
                                                             as.character(contract.df$prime_award_description[1]), 
                                                             contract.df$prime_award_amount[1], 
                                                             'contractee')

all.filtered.subcontracters.df <- filtered.contracts.df %>%
  select(subawardee_name, subaward_amount) %>%
  group_by(subawardee_name) %>%
  summarize(cost = sum(subaward_amount)) %>%
  ungroup() %>%
  mutate(id = subawardee_name,
         name = subawardee_name,
         description = subawardee_name,
         type = 'subawardee') %>%
  select(id, name, description, cost, type)

result.filtered.costs.df <- rbind(all.filtered.costs.df, all.filtered.subcontracters.df) %>%
  filter(id %in% filtered.first.layer$from | 
         id %in% filtered.first.layer$to | 
         id %in% filtered.second.layer$from | 
         id %in% filtered.second.layer$to)

# Scaled radius
a <- 10
b <- 50
result.filtered.costs.df <- result.filtered.costs.df %>%
  select(id, name, description, cost, type) %>%
  mutate(cost = as.numeric(cost)) %>%
  mutate(scaled_radius = round(((b - a) * (cost - min(.$cost))) / (max(.$cost) - min(.$cost)), digits = 0) + a)


result.filtered.costs.df <- result.filtered.costs.df %>%
  mutate(cost = as.character(cost))
write.csv(result.filtered.costs.df, "./visualization_data/all_filtered_costs.csv", row.names = FALSE)
```

## Word Analysis
```{r}
vcorpus <- VCorpus(VectorSource(filtered.contracts.df$subaward_description))
toSpace <- content_transformer(function(x, pattern) gsub(pattern, " ", x))
vcorpus <- tm_map(vcorpus, toSpace, "&")
vcorpus <- tm_map(vcorpus, removePunctuation)
vcorpus <- tm_map(vcorpus, removeNumbers)
vcorpus <- tm_map(vcorpus, removeWords, stopwords("english"))
vcorpus <- tm_map(vcorpus, content_transformer(tolower))
vcorpus <- tm_map(vcorpus, stripWhitespace)

dtm <- DocumentTermMatrix(vcorpus, control = list(wordLengths = c(3, 20)))

dtm.matrix <- as.matrix(dtm)
dtm.sorted.matrix <- sort(colSums(dtm.matrix), decreasing = TRUE)
descriptions.df <- data.frame(words = names(dtm.sorted.matrix), freq = dtm.sorted.matrix) %>%
  filter(words %in% GradyAugmented)
descriptions.df

# Understanding the descriptions
write.csv(descriptions.df, "./visualization_data/filtered_descriptions.csv", row.names = FALSE)
```

## Create a network for the important words

```{r}
# Based on the wordcloud, these seem like the most important contracts
important.words <- c('batteries', 'antenna', 'missile', 'cable', 'encoders', 
                     'lithium', 'chargers', 'connector', 'detonator', 'explosive',
                     'fuselage', 'launchers', 'receivers', 'titanium', 'wire', 'adaptors',
                     'bolts', 'computer', 'fasteners', 'fuses', 'gears', 'metal', 'motors',
                     'nuts', 'pumps', 'pyrotechnic', 'rocket', 'rubber', 
                     'seals', 'transmitters', 'valves', 'washers', 'shafts')
important.words.grep <- paste(important.words, collapse = '|')

description.filtered.contracts.df <- filtered.contracts.df %>%
  filter(grepl(important.words.grep, subaward_description, ignore.case = TRUE))

extracted.words <- lapply(description.filtered.contracts.df$subaward_description, 
                          FUN = function(x) { str_extract_all(x, regex(important.words.grep, ignore_case = TRUE)) })

compressed.words <- data.frame(extracted_words = '', number_of_words = 0)
for (word in extracted.words) {
  compressed.list <- paste(unique(unlist(word)), collapse = ',')
  number.of.words <- length(unique(unlist(word)))
  compressed.words <- compressed.words %>% 
    add_row(extracted_words = compressed.list,
            number_of_words = number.of.words)
}
description.filtered.contracts.df <- cbind(description.filtered.contracts.df, compressed.words[-1, ])
```

## Quick viz for understanding breakdown of words

```{r}
words.group.df <- description.filtered.contracts.df %>% 
  select(number_of_words) %>%
  group_by(number_of_words) %>%
  count(name = 'value')

write.csv(words.group.df, "./visualization_data/word_counts.csv", row.names = FALSE)
```


### Recreate subcontract network (Nodes > 1)
```{r}
top.description.based.subcontracts.df <- description.filtered.contracts.df %>%
  filter(number_of_words > 1) %>%
  group_by(subawardee_name) %>%
  summarize(NumberOfContracts = n(),
            TotalCostOfAllContracts = sum(subaward_amount)) %>%
  arrange(desc(TotalCostOfAllContracts))

second.description.based.layer <- description.filtered.contracts.df %>%
  filter(number_of_words > 1) %>%
  select(subcontract_id, subawardee_name) %>%
  filter(subawardee_name %in% top.description.based.subcontracts.df$subawardee_name) %>%
  mutate(from = as.character(subcontract_id),
         to = as.character(subawardee_name)) %>%
  select(from, to)

first.description.based.layer <- description.filtered.contracts.df %>%
  filter(number_of_words > 1) %>%
  select(subcontract_id, prime_awardee_name) %>%
  filter(subcontract_id %in% second.description.based.layer$from) %>%
  mutate(from = as.character(prime_awardee_name),
         to = as.character(subcontract_id)) %>%
  select(from, to)

write.csv(do.call('rbind', list(first.description.based.layer, second.description.based.layer)), "./visualization_data/subcontract_description_g1_based_network.csv", row.names = FALSE)
```

### Recreate Description Based Cost Nodes (Nodes > 1)
```{r}
all.filtered.description.based.costs.df <- description.filtered.contracts.df %>%
  filter(number_of_words > 1) %>%
  select(subcontract_id, subaward_description, extracted_words, subaward_amount) %>%
  rename(id = subcontract_id,
         description = subaward_description,
         cost = subaward_amount) %>%
  mutate(type = 'subcontract',
         name = description,
         extracted_words = extracted_words) %>%
  select(id, name, description, extracted_words, cost, type)
all.filtered.description.based.costs.df[nrow(all.filtered.description.based.costs.df) + 1,] <- c(as.character(contract.df$prime_awardee_name[1]), 
                                                                                                 as.character(contract.df$prime_awardee_name[1]), 
                                                                                                 as.character(contract.df$prime_award_description[1]),
                                                                                                 '',
                                                                                                 contract.df$prime_award_amount[1], 
                                                                                                 'contractee')

all.filtered.description.based.subcontracters.df <- description.filtered.contracts.df %>%
  filter(number_of_words > 1) %>%
  select(subawardee_name, subaward_amount) %>%
  group_by(subawardee_name) %>%
  summarize(cost = sum(subaward_amount)) %>%
  ungroup() %>%
  mutate(id = subawardee_name,
         name = subawardee_name,
         description = subawardee_name,
         extracted_words = '',
         type = 'subawardee') %>%
  select(id, name, description, extracted_words, cost, type)

result.filtered.description.costs.df <- rbind(all.filtered.description.based.costs.df, all.filtered.description.based.subcontracters.df) %>%
  filter(id %in% first.description.based.layer$from | 
         id %in% first.description.based.layer$to | 
         id %in% second.description.based.layer$from | 
         id %in% second.description.based.layer$to)

# Scaled radius
a <- 10
b <- 50
result.filtered.description.costs.df <- result.filtered.description.costs.df %>%
  select(id, name, description, extracted_words, cost, type) %>%
  mutate(cost = as.numeric(cost)) %>%
  mutate(scaled_radius = round(((b - a) * (cost - min(.$cost))) / (max(.$cost) - min(.$cost)), digits = 0) + a)


result.filtered.description.costs.df <- result.filtered.description.costs.df %>%
  mutate(cost = as.character(cost))
write.csv(result.filtered.description.costs.df, "./visualization_data/all_filtered_description_g1_based_costs.csv", row.names = FALSE)
```

### Recreate subcontract network(Nodes = 1)
```{r}
top.description.based.subcontracts.df <- description.filtered.contracts.df %>%
  filter(number_of_words == 1) %>%
  group_by(subawardee_name) %>%
  summarize(NumberOfContracts = n(),
            TotalCostOfAllContracts = sum(subaward_amount)) %>%
  arrange(desc(TotalCostOfAllContracts))

second.description.based.layer <- description.filtered.contracts.df %>%
  filter(number_of_words == 1) %>%
  select(subcontract_id, subawardee_name) %>%
  filter(subawardee_name %in% top.description.based.subcontracts.df$subawardee_name) %>%
  mutate(from = as.character(subcontract_id),
         to = as.character(subawardee_name)) %>%
  select(from, to)

first.description.based.layer <- description.filtered.contracts.df %>%
  filter(number_of_words == 1) %>%
  select(subcontract_id, prime_awardee_name) %>%
  filter(subcontract_id %in% second.description.based.layer$from) %>%
  mutate(from = as.character(prime_awardee_name),
         to = as.character(subcontract_id)) %>%
  select(from, to)

write.csv(do.call('rbind', list(first.description.based.layer, second.description.based.layer)), "./visualization_data/subcontract_description_1_based_network.csv", row.names = FALSE)
```

### Recreate Description Based Cost Nodes (Nodes = 1)
```{r}
all.filtered.description.based.costs.df <- description.filtered.contracts.df %>%
  filter(number_of_words == 1) %>%
  select(subcontract_id, subaward_description, extracted_words, subaward_amount) %>%
  rename(id = subcontract_id,
         description = subaward_description,
         cost = subaward_amount) %>%
  mutate(type = 'subcontract',
         name = description,
         extracted_words = extracted_words) %>%
  select(id, name, description, extracted_words, cost, type)
all.filtered.description.based.costs.df[nrow(all.filtered.description.based.costs.df) + 1,] <- c(as.character(contract.df$prime_awardee_name[1]), 
                                                                                                 as.character(contract.df$prime_awardee_name[1]), 
                                                                                                 as.character(contract.df$prime_award_description[1]),
                                                                                                 '',
                                                                                                 contract.df$prime_award_amount[1], 
                                                                                                 'contractee')

all.filtered.description.based.subcontracters.df <- description.filtered.contracts.df %>%
  filter(number_of_words == 1) %>%
  select(subawardee_name, subaward_amount) %>%
  group_by(subawardee_name) %>%
  summarize(cost = sum(subaward_amount)) %>%
  ungroup() %>%
  mutate(id = subawardee_name,
         name = subawardee_name,
         description = subawardee_name,
         extracted_words = '',
         type = 'subawardee') %>%
  select(id, name, description, extracted_words, cost, type)

result.filtered.description.costs.df <- rbind(all.filtered.description.based.costs.df, all.filtered.description.based.subcontracters.df) %>%
  filter(id %in% first.description.based.layer$from | 
         id %in% first.description.based.layer$to | 
         id %in% second.description.based.layer$from | 
         id %in% second.description.based.layer$to)

# Scaled radius
a <- 10
b <- 50
result.filtered.description.costs.df <- result.filtered.description.costs.df %>%
  select(id, name, description, extracted_words, cost, type) %>%
  mutate(cost = as.numeric(cost)) %>%
  mutate(scaled_radius = round(((b - a) * (cost - min(.$cost))) / (max(.$cost) - min(.$cost)), digits = 0) + a)


result.filtered.description.costs.df <- result.filtered.description.costs.df %>%
  mutate(cost = as.character(cost))
write.csv(result.filtered.description.costs.df, "./visualization_data/all_filtered_description_1_based_costs.csv", row.names = FALSE)
```